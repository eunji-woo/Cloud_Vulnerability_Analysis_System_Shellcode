#!/bin/bash

# 작성날짜 : 2022년 7월 6일 
# 작성자 : 우은지, 이은경
# 동작방식 : SMTP 서버의 릴레이 기능 활성화 여부를 확인하는 코드

value1=$(ps -ef | grep sendmail | grep -v "grep") # 현재 실행 중인 프로세스 목록에 sendmail이 있는지 grep하여 확인
#value2=$(cat /etc/mail/sendmail.cf | grep "R$\*" |grep "Relaying denied") # sendmail 설정 파일에 relaying service를 deny하고 있는지 grep하여 확인

vuln_number="U31"
vuln_name="스팸 메일 릴레이 제한"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"
vuln_type="서비스 관리"
vuln_severity="3"
vuln_result="취약하지 않음"
vuln_desc="SMTP 서비스를 사용하고 릴레이 제한이 설정되어 있지 않음"
vuln_host_id=$(hostname -I)

if [ -n "$value1" ] # sendmail을 사용중이라면 #-n 뭐라도 있으면 참
then
        if [ -n "$(cat /etc/mail/sendmail.cf | grep "R$\*" |grep "Relaying denied")" ] # relaying service를 거부하고 있다면
        then # 즉 sendmail은 사용하고 relaying 서비스는 제한되어 있음
                vuln_result="취약하지 않음"
                vuln_desc="SMTP 서비스를 사용중이며 릴레이 제한이 설정되어 있음"
        else # sendmail은 사용하고 relaying 서비스도 사용중이라면
                vuln_result="취약함"
                vuln_desc="SMTP 서비스를 사용중이며 릴레이 제한이 설정되어 있지 않음"
        fi
else # sendmail를 사용중이지 않고
        if [ -n "$(cat /etc/mail/sendmail.cf | grep "R$\*" |grep "Relaying denied")" ] # relaying service를 거부하고 있다면
        then # 즉 sendmail은 사용하지 않고 relaying 서비스는 제한되어 있음
                vuln_result="취약하지 않음"
                vuln_desc="SMTP 서비스를 사용하지 않고 릴레이 제한이 설정되어 있음"
                vuln_result="취약하지 않음"    
        else # sendmail은 사용하지 않고 relaying 서비스는 사용한다면
                vuln_desc="SMTP 서비스를 사용하지 않고 릴레이 제한이 설정되어 있지 않음"
        fi
        
fi

echo "{\\"vuln_number\\":\\"${vuln_number}\\", \\"vuln_name\\":\\"${vuln_name}\\", \\"vuln_result_date\\":\\"${vuln_result_date}\\", \\"vuln_type\\":\\"${vuln_type}\\", \\"vuln_severity\\":\\"${vuln_severity}\\", \\"vuln_result\\":\\"${vuln_result}\\", \\"vuln_desc\\":\\"${vuln_desc}\\", \\"vuln_host_id\\":\\"${vuln_host_id}\\"}" >> result.log
