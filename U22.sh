#!/bin/bash

# 작성날짜 : 2022년 6월 8일, 8월 24일
# 작성자 : 우은지, 이은경
# 동작방식 : r 계열 서비스들이 비활성화가 되어있는지 xinetd 디렉토리 밑에 있는 파일들을 보며 확인
# ->r 서비스 파일들을 cat 해온 뒤, disable이 grep 될 경우 safe로 판단, grep 되지 않을 경우 unsafe로 판단

vuln_number="U22"
vuln_name="r 계열 서비스 비활성화"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"
vuln_type="서비스 관리"
vuln_severity="3"
vuln_result="취약하지 않음"
vuln_desc="r 계열 서비스 관련 파일이 없음"
vuln_host_id=$(hostname -I)

for x in `ls -1 /etc/xinetd.d | egrep 'rsh'*` # r 계열 서비스들 파일 이름이 서비스이름-stream, dgram,, 등 다양
do
    result=$(cat /etc/xinetd.d/$x | egrep disable*)
    if [[ $result == *yes* ]]; then
        vuln_desc+="$x가 비활성화 되어 있음\n"
    else
        vuln_desc+="$x가 활성화 되어 있음\n"
    fi
done


for x in `ls -1 /etc/xinetd.d | egrep 'rlogin'*`
do
    result=$(cat /etc/xinetd.d/$x | egrep disable*)
    if [[ $result == *yes* ]]; then
        vuln_desc+="$x가 비활성화 되어 있음\n"
    else
        vuln_desc+="$x가 활성화 되어 있음\n"
    fi
done


for x in `ls -1 /etc/xinetd.d | egrep 'rexec'*`
do
    result=$(cat /etc/xinetd.d/$x | egrep disable*)
    if [[ $result == *yes* ]]; then
        vuln_desc+="$x가 비활성화 되어 있음"
    else
        vuln_desc+="$x가 활성화 되어 있음"
    fi
done

echo "{\"vuln_number\":\"${vuln_number}\", \"vuln_name\":\"${vuln_name}\", \"vuln_result_date\":\"${vuln_result_date}\", \"vuln_type\":\"${vuln_type}\", \"vuln_severity\":\"${vuln_severity}\", \"vuln_result\":\"${vuln_result}\", \"vuln_desc\":\"${vuln_desc}\", \"vuln_host_id\":\"${vuln_host_id}\"}" >> result.log