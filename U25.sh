#!/bin/bash

# 작성날짜 : 2022년 9월 3일 
# 작성자 : 이은경, 우은지
# 동작방식 : nfs 접근통제

vuln_number="U25"
vuln_name="nfs 접근통제"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"
vuln_type="계정 관리"
vuln_severity="3"
vuln_result=""
vuln_desc=""
vuln_host_id=$(hostname -I)

CHECK1=$(systemctl list-unit-files nfs-server.service | grep ^nfs | awk '{print $2}') # nfs 사용 중인지 확인 (enable, disabled)
CHECK2=$(showmount -e $HOSTNAME | grep everyone | wc -l)
CHECK3=0

while read line
do
    line=$("$line" | awk "{print $2}")
    # if [ -z `"$line" | awk "{print $2}" | grep -E "[^\*(]"|"all_squash"` ] || [ -z `"$line" | awk "{print $2}" | grep -E "[^\*(]"|"no_root_squash"` ]; then
    #     CHECK3=1
    # fi
    
done < /etc/exports

if [ $CHECK1 == 'disabled' ] || [ $CHECK2 = 0 ] || [ $CHECK3 = 0 ]; then
    vuln_result="취약하지 않음"
   vuln_desc="불필요한 NFS 서비스를 사용하지 않거나, 불가피하게 사용 시 everyone 공유를 제한하고 있음"
else
    vuln_result="취약함"
   vuln_desc="불필요한 NFS 서비스를 사용하고 있고, everyone 공유를 제한하지 않고 있거나, 접근 통제 설정이 안전하지 않음"
fi

echo "{\"vuln_number\":\"${vuln_number}\", \"vuln_name\":\"${vuln_name}\", \"vuln_result_date\":\"${vuln_result_date}\", \"vuln_type\":\"${vuln_type}\", \"vuln_severity\":\"${vuln_severity}\", \"vuln_result\":\"${vuln_result}\", \"vuln_desc\":\"${vuln_desc}\", \"vuln_host_id\":\"${vuln_host_id}\"}" >> result.log