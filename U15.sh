#!/bin/bash

# 작성날짜 : 2022년 9월 2일 
# 작성자 : 우은지
# 동작방식 : 사용자, 시스템 시작파일 및 환경파일 소유자 및 권한 설정을 확인하기 위한 코드
# 사용자 홈 디렉토리 이름 확인하고 홈 디렉토리 소유자 및 권한 확인

vuln_number="U15"
vuln_name="사용자, 시스템 시작파일 및 환경파일 소유자 및 권한 설정"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"
vuln_type="계정 관리"
vuln_severity="3"
vuln_result="취약함"
vuln_desc=""
vuln_host_id=$(hostname -I)

user_name=$(cat /etc/passwd | grep \home | awk '{print $2}')  # 사용자 home 디렉토리 이름 가져오는 과정
user_name="${user_name#*home/}"  # %%{특정문자열}* => 해당 문자열 기준 앞 부분을 가져옴
user_name="${user_name%%:*}"   # #*{특정문자열} => 해당 문자열 뒷 부분을 가져옴

check1=$(stat -c %a /home/$user_name) # stat %a 포매팅 = 권한을 8진수로 알려줌
check2=$(stat -c "%U" /home/$user_name) # stat %U 포매팅 = 파일 소유자 알려줌


if [ "$check2" == "root" ] || [ "$check2" == "$user_name" ]; then
    if [ "$check1" == 644 ]; then
        vuln_result="취약하지 않음"
        vuln_desc="사용자, 시스템 시작파일 및 환경 파일 소유자가 root 또는 해당 계정이고 권한이 644임"
    else
        vuln_desc="사용자, 시스템 시작파일 및 환경 파일 소유자가 root 또는 해당 계정이지만 권한이 644가 아님"
    fi
else
    vuln_desc="사용자, 시스템 시작파일 및 환경 파일 소유자가 root 또는 해당 계정이 아님"
fi

echo "{\\"vuln_number\":\\"${vuln_number}\\", \\"vuln_name\\":\\"${vuln_name}\\", \\"vuln_result_date\\":\\"${vuln_result_date}\\", \\"vuln_type\\":\\"${vuln_type}\\", \\"vuln_severity\\":\\"${vuln_severity}\\", \\"vuln_result\\":\\"${vuln_result}\\", \\"vuln_desc\\":\\"${vuln_desc}\\", \\"vuln_host_id\\":\\"${vuln_host_id}\\"}" >> result.log
