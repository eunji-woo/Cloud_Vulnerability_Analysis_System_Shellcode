#!/bin/bash

# 작성날짜 : 2022년 5월 30일, 8월 31일
# 작성자 : 이은경
# 동작방식 : $HOME/.rhosts, hosts.equiv 소유자 및 권한 확인
# login, shell, exec 서비스를 사용하지 않으면 safe
# /etc/hosts.equiv, $HOME/.rhosts 파일 소유자가 root 또는 해당 계정이고, 파일 권한이 600이하이며 파일 설정에 '+'설정이 없으면 safe

vuln_number="U17"
vuln_name="$Home/.rhosts, hosts.equiv 사용 금지"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"
vuln_type="파일 및 디렉토리 관리"
vuln_severity="3"
vuln_result="취약함"
vuln_desc="login, shell, exec 서비스를 사용하고 있음"
vuln_host_id=$(hostname -I)

checkRoot1=$(ls -l /etc/hosts.equiv | awk '{print $3}')
checkRoot2="$(ls -l ~/rhosts | awk '{print $3}')"

checkPlus1=$(cat /etc/hosts.equiv | grep "+")
checkPlus2=$(cat ~/rhosts | grep "+")

if [ "$checkRoot1" == 'root' ] && [ "$checkRoot2" == 'root' ];then
    vuln_desc+="각 파일의 소유자는 root이고"
    if [ `stat -c %a /etc/hosts.equiv` -le 600 ];then 
        vuln_desc+="파일 권한은 600이하, "
        if [ -n "$checkPlus1" ] && [ -n "$checkPlus2" ];then
            vuln_desc+="'+'설정 없음 "
            vuln_result="취약하지 않음"
        else
            vuln_desc+="'+'설정 있음 "
        fi
    else
        vuln_desc+="파일 권한은 600보다 크다 "
    fi
else
    vuln_desc+="각 파일의 소유자는 root이 아니다"
fi


echo "{\\"vuln_number\\":\\"${vuln_number}\\", \\"vuln_name\\":\\"${vuln_name}\\", \\"vuln_result_date\\":\\"${vuln_result_date}\\", \\"vuln_type\\":\\"${vuln_type}\\", \\"vuln_severity\\":\\"${vuln_severity}\\", \\"vuln_result\\":\\"${vuln_result}\\", \\"vuln_desc\\":\\"${vuln_desc}\\", \\"vuln_host_id\\":\\"${vuln_host_id}\\"}" >> result.log
