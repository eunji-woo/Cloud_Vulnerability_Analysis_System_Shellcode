# /bin/bash

# 작성날짜 : 2022년 7월 25일 
# 작성자 : 우은지
# 동작방식 : 패스워드 복잡성 설정이 안전한지 확인하기 위한 코드 (function.sh이 어디에 있는거죠..)

checkList=("dcredit" "ucredit" "Icredit" "ocredit" "minlen")
# 순서대로 root 계정에도 정책을 적용할건지, 숫자 최소 사용을 어떻게 할건지, 대문자 최소 사용을 어떻게 할건지, 대문자 사용을 어떻게 할건지, 특수문자 사용을 어떻게 할건지를 의미한다.
# 각 값이 -1이라는 건 반드시 해당 문자를 포함시켜야한다는 의미이다.

vuln_number="U2"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"vuln_type="계정 관리"
vuln_severity="3"
vuln_result="취약하지 않음"
vuln_desc="/etc/security/pwquality.conf 파일에서 패스워드 복잡성 잘 설정되어있음"
vuln_host_id=$(hostname -I)

FileName=/etc/security/pwquality.conf
CheckMinlen=$(cat $FileName | grep "minlen" | awk '{print $4}')
Checkeroot=$(cat $FileName | grep "enforce_for_root")

for i in "${checkList[@]}"; do
    option=$(cat $FileName | grep $i | awk '{print $4}')
    if [ "$option" == "0"  ];then
        vuln_result="취약함"
        vuln_desc="/etc/security/pwquality.conf 파일에서 패스워드 복잡성 설정 확인"
        break
    fi
done

if [ $CheckMinlen -ge 8 ];then #최소길이 8 이상
    vuln_result+=" 취약하지 않음 (최소 길이 8 이상으로 설정됨)"
    vuln_desc=
else
    vuln_result+=" 취약함 (최소 길이 8 이하로 설정됨)"
fi

if [ $Checkeroot ];then # root 계정에도 정책 적용하는지 확인
    vuln_result+=" 취약하지 않음 (root 계정에 정책 적용)"
else
    vuln_result+=" 취약함 (root 계정에 정책 적용 안함)"
fi

echo "{\"vuln_number\":\"U2\", \"vuln_result_date\":\"${vuln_result_date}\", \"vuln_severity\":\"${vuln_severity}\", \"vuln_result\":\"${vuln_result}\", \"vuln_host_id\":\"${vuln_host_id}\"}" >> u02.log