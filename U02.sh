# /bin/bash

# 작성날짜 : 2022년 7월 25일 
# 작성자 : 우은지
# 동작방식 : 패스워드 복잡성 설정이 안전한지 확인하기 위한 코드 (function.sh이 어디에 있는거죠..)

checkList=("dcredit" "ucredit" "Icredit" "ocredit" "minlen")
# 순서대로 root 계정에도 정책을 적용할건지, 숫자 최소 사용을 어떻게 할건지, 대문자 최소 사용을 어떻게 할건지, 대문자 사용을 어떻게 할건지, 특수문자 사용을 어떻게 할건지를 의미한다.
# 각 값이 -1이라는 건 반드시 해당 문자를 포함시켜야한다는 의미이다.

vuln_number="U2"
vuln_name="패스워드 복잡성 설정"
vuln_result_date="$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)"vuln_type="계정 관리"
vuln_severity="3"
vuln_result="취약하지 않음"
vuln_desc="/etc/security/pwquality.conf 파일에서 패스워드 복잡성 잘 설정되어있음"
vuln_host_id=$(hostname -I)

FileName=/etc/security/pwquality.conf
CheckMinlen=$(cat $FileName | grep "minlen" | awk '{print $4}')
Checkeroot=$(cat $FileName | grep "enforce_for_root")

vuln_flag = 0 # 취약하지 않음

for i in "${checkList[@]}"; do
    option=$(cat $FileName | grep $i | awk '{print $4}')
    if [ "$option" == "0"  ];then
        vuln_flag=1
        vuln_desc="/etc/security/pwquality.conf 파일에서 패스워드 복잡성 설정 확인"
        break
    fi
done

if [ $CheckMinlen -le 8 ];then #최소길이 8 이상
    if [ $vuln_flag -e 1 ]; then
         vuln_desc="패스워드 복잡성 설정 확인 필요하며, 최소 길이 8 이하로 설정됨"  
    else
        vuln_flag=1
        vuln_desc="최소 길이 8 이하로 설정됨"
    fi
fi

if [ -n $Checkeroot ];then # root 계정에도 정책 적용하는지 확인
    if [ $vuln_flag -e 1 ]; then
         vuln_desc="패스워드 복잡성 설정 확인 필요하며, 최소 길이 8 이하로 설정됨, root 계정에 정책 적용 안함"
    else
        vuln_flag=1
        vuln_desc="root 계정에 정책 적용 안함"
    fi
fi

if [ $vuln_flag -e 1 ];then
    vuln_result=" 취약함"

echo "{\"vuln_number\":\"${vuln_number}\", \"vuln_name\":\"${vuln_name}\", \"vuln_result_date\":\"${vuln_result_date}\", \"vuln_type\":\"${vuln_type}\", \"vuln_severity\":\"${vuln_severity}\", \"vuln_result\":\"${vuln_result}\", \"vuln_desc\":\"${vuln_desc}\", \"vuln_host_id\":\"${vuln_host_id}\"}" >> result.log